<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Your Listings | House AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4A6FFF',
            secondary: '#00C853',
            accent: '#FF6D00',
            light: '#F8F9FA',
            dark: '#212529',
          },
          fontFamily: {
            poppins: ['Poppins', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #4A6FFF 0%, #6A8CFF 50%, #8B5CF6 100%);
    }
    .glass-effect {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
    }
    .glass-effect-dark {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.1);
    }
    .text-gradient {
      background: linear-gradient(135deg, #4A6FFF, #8B5CF6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .property-img {
      height: 200px;
      object-fit: cover;
      width: 100%;
    }
    .floating-animation {
      animation: float 6s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #4A6FFF;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="text-gray-800 gradient-bg">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-64 glass-effect shadow-2xl border-r border-white/20 flex flex-col">
      <div class="p-6 border-b border-white/20">
        <div class="flex items-center mb-2">
          <div class="w-10 h-10 bg-gradient-to-r from-primary to-purple-600 rounded-lg flex items-center justify-center mr-3">
            <i data-lucide="home" class="w-5 h-5 text-white"></i>
          </div>
          <h2 class="text-2xl font-bold text-gradient">House AI</h2>
        </div>
        <p class="text-xs text-gray-500 mt-1">Ø¢Ø¤ Ú¯Ú¾Ø± ÚˆÚ¾ÙˆÙ†ÚˆÛŒÚº</p>
      </div>
      
      <div class="p-6 border-b border-white/20">
        <div class="w-16 h-16 bg-gray-200 rounded-full mx-auto mb-3 flex items-center justify-center text-gray-500">
          <i data-lucide="user" class="w-8 h-8"></i>
        </div>
        <p class="text-center font-semibold text-lg">Ahmad Khan</p>
        <p class="text-center text-sm text-gray-500">ahmad@example.com</p>
      </div>
      <nav class="mt-4 space-y-2 px-4 flex-1">
        <a href="dashboard-owner" class="block px-4 py-3 rounded-xl bg-blue-100 text-primary font-medium flex items-center transition-all hover:bg-blue-200">
          <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
          Dashboard
        </a>
        <a href="upload" class="block px-4 py-3 rounded-xl hover:bg-gray-100 flex items-center transition-all">
          <i data-lucide="plus-circle" class="w-5 h-5 mr-3 text-gray-600"></i>
          Add New Listing
        </a>
        <a href="#" class="block px-4 py-3 rounded-xl hover:bg-gray-100 flex items-center transition-all">
          <i data-lucide="message-square" class="w-5 h-5 mr-3 text-gray-600"></i>
          Messages
        </a>
        <a href="#" class="block px-4 py-3 rounded-xl hover:bg-gray-100 flex items-center transition-all">
          <i data-lucide="bar-chart-2" class="w-5 h-5 mr-3 text-gray-600"></i>
          Analytics
        </a>
        <a href="#" class="block px-4 py-3 rounded-xl hover:bg-gray-100 flex items-center transition-all">
          <i data-lucide="settings" class="w-5 h-5 mr-3 text-gray-600"></i>
          Settings
        </a>
      </nav>
      <div class="p-4 border-t border-white/20">
        <a href="/" class="block px-4 py-3 text-red-600 hover:bg-red-50 rounded-xl flex items-center transition-all">
          <i data-lucide="log-out" class="w-5 h-5 mr-3"></i>
          Logout
        </a>
      </div>
    </div>
    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Top Bar -->
      <header class="glass-effect shadow-xl px-6 py-4 border-b border-white/20 flex items-center justify-between">
        <div class="flex items-center">
          <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3 text-gray-500">
            <i data-lucide="user" class="w-5 h-5"></i>
          </div>
          <div>
            <h1 class="text-xl font-semibold">Your Listed Properties</h1>
            <p class="text-gray-600 text-sm">Manage your rentals and track interest.</p>
          </div>
        </div>
        <a href="upload" class="bg-gradient-to-r from-primary to-purple-600 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all text-sm flex items-center">
          <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
          Add New
        </a>
      </header>
      <!-- Listings Grid -->
      <main class="p-6 overflow-y-auto relative" style="height: calc(100vh - 80px);">
        <!-- Background Pattern -->
        <div class="absolute inset-0 opacity-5">
          <div class="absolute top-10 left-10 w-24 h-24 border border-blue-300 rounded-full floating-animation"></div>
          <div class="absolute top-60 right-20 w-16 h-16 border border-purple-300 rounded-full floating-animation" style="animation-delay: -2s;"></div>
          <div class="absolute bottom-20 left-40 w-12 h-12 border border-green-300 rounded-full floating-animation" style="animation-delay: -4s;"></div>
        </div>
        <!-- Success Message -->
        <div id="success-msg" class="hidden glass-effect border border-green-200 text-green-800 p-4 rounded-xl mb-6 flex items-center relative z-10">
          <i data-lucide="check-circle" class="w-5 h-5 mr-2 text-green-600"></i>
          ðŸŽ‰ Your new listing has been added successfully!
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden glass-effect border border-blue-200 text-blue-800 p-4 rounded-xl mb-6 flex items-center justify-center relative z-10">
          <div class="loading-spinner mr-3"></div>
          Loading your properties...
        </div>
        
        <!-- Error Message -->
        <div id="error-msg" class="hidden glass-effect border border-red-200 text-red-800 p-4 rounded-xl mb-6 flex items-center relative z-10">
          <i data-lucide="alert-circle" class="w-5 h-5 mr-2 text-red-600"></i>
          Failed to load properties. Please try again.
        </div>
        
        <!-- Properties Container -->
        <div id="properties-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 relative z-10">
          <!-- Property cards will be dynamically loaded here -->
        </div>
        
        <!-- Add New Button -->
        <a href="upload" class="glass-effect flex flex-col items-center justify-center border-2 border-dashed border-primary rounded-xl p-12 text-primary hover:bg-blue-50 transition-all transform hover:scale-[1.01] shadow-lg">
          <div class="w-16 h-16 bg-gradient-to-r from-primary to-purple-600 text-white rounded-full flex items-center justify-center mb-4 shadow-md">
            <i data-lucide="plus" class="h-8 w-8"></i>
          </div>
          <span class="text-lg font-semibold">Add a New Property</span>
          <p class="text-sm text-gray-600 mt-1">List your house in minutes</p>
        </a>
      </main>
    </div>
  </div>
  
  <!-- Property Detail Template (Hidden) -->
  <template id="property-card-template">
    <div class="glass-effect rounded-xl overflow-hidden shadow-xl border border-white/20 hover:shadow-2xl transition-all transform hover:scale-[1.01]">
      <img src="https://images.unsplash.com/photo-1600585154340-be6161a56a0c?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80" alt="Property" class="property-img">
      <div class="p-5">
        <div class="flex justify-between items-start mb-3">
          <div>
            <h3 class="font-bold text-lg property-title"></h3>
            <p class="text-gray-600 text-sm property-price"></p>
          </div>
          <span class="property-status text-xs px-3 py-1 rounded-full flex items-center">
            <i class="w-3 h-3 mr-1"></i>
            <span class="status-text"></span>
          </span>
        </div>
        <div class="grid grid-cols-2 gap-2 text-sm text-gray-500 mb-4">
          <div class="flex items-center">
            <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>
            <span class="property-location"></span>
          </div>
          <div class="flex items-center">
            <i data-lucide="square" class="w-4 h-4 mr-2"></i>
            <span class="property-size"></span>
          </div>
          <div class="flex items-center">
            <i data-lucide="bed" class="w-4 h-4 mr-2"></i>
            <span class="property-beds"></span>
          </div>
          <div class="flex items-center">
            <i data-lucide="droplets" class="w-4 h-4 mr-2"></i>
            <span class="property-baths"></span>
          </div>
        </div>
        <div class="flex flex-wrap gap-2">
          <a href="property-detail.html" class="text-primary text-sm hover:underline flex items-center view-btn">
            <i data-lucide="eye" class="w-4 h-4 mr-1"></i>
            View
          </a>
          <a href="#" class="text-gray-600 text-sm hover:underline flex items-center edit-btn">
            <i data-lucide="edit" class="w-4 h-4 mr-1"></i>
            Edit
          </a>
          <button class="status-toggle text-sm hover:underline flex items-center">
            <i data-lucide="toggle-left" class="w-4 h-4 mr-1"></i>
            <span class="toggle-text"></span>
          </button>
        </div>
      </div>
    </div>
  </template>
  
  <!-- JavaScript -->
<script>
  // Initialize Lucide icons
  lucide.createIcons();

  // Check for success message from upload page
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('uploadSuccess') === 'true') {
    document.getElementById('success-msg').classList.remove('hidden');
    // Remove the query parameter after showing the message
    history.replaceState({}, document.title, window.location.pathname);
  }

  // Load user properties from localStorage AND rental_metadata_90k.csv
  async function loadUserProperties() {
    const container = document.getElementById('properties-container');
    const loadingIndicator = document.getElementById('loading-indicator');
    const errorMsg = document.getElementById('error-msg');
    const template = document.getElementById('property-card-template');

    // Show loading indicator
    loadingIndicator.classList.remove('hidden');
    errorMsg.classList.add('hidden');

    try {
      // Load properties from localStorage (owner-added)
      const localProperties = JSON.parse(localStorage.getItem('properties') || '[]');

      // Load full dataset from Flask /data/ route
      const response = await fetch('/data/rental_metadata_90k.csv');
      if (!response.ok) throw new Error("Failed to load CSV");

      const csvText = await response.text();
      const lines = csvText.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const allProperties = [];

      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.length >= headers.length) {
          const row = {};
          headers.forEach((header, idx) => {
            row[header] = values[idx] ? values[idx].trim().replace(/"/g, '') : "";
          });
          allProperties.push(row);
        }
      }

      // Combine local + CSV properties (avoid duplicates)
      const combined = [...localProperties];
      allProperties.forEach(p => {
        if (!combined.some(c => c.id == p.id)) {
          combined.push(p);
        }
      });

      // Clear container
      container.innerHTML = '';

      // Add property cards
      combined.forEach(property => {
        const card = template.content.cloneNode(true);

        // Update card content
        card.querySelector('.property-title').textContent = `${property.area}, ${property.city}`;
        card.querySelector('.property-price').textContent = `PKR ${parseInt(property.price).toLocaleString()}`;

        // Update status badge
        const statusElement = card.querySelector('.property-status');
        const statusText = card.querySelector('.status-text');

        if (property.status === 'available') {
          statusElement.className = 'property-status bg-green-100 text-green-800 text-xs px-3 py-1 rounded-full flex items-center';
          statusElement.querySelector('i').setAttribute('data-lucide', 'check-circle');
          statusText.textContent = 'Available';
        } else {
          statusElement.className = 'property-status bg-red-100 text-red-800 text-xs px-3 py-1 rounded-full flex items-center';
          statusElement.querySelector('i').setAttribute('data-lucide', 'home');
          statusText.textContent = 'Rented';
        }

        card.querySelector('.property-location').textContent = property.location;
        card.querySelector('.property-size').textContent = `${property.size_marla} Marla`;
        card.querySelector('.property-beds').textContent = `${property.bedrooms} Beds`;
        card.querySelector('.property-baths').textContent = `${property.bathrooms} Baths`;

        // âœ… FIX: Correct link to property detail
        const viewBtn = card.querySelector('.view-btn');
        viewBtn.href = `/property-detail?id=${property.id}`;

        // Setup status toggle button
        const statusToggle = card.querySelector('.status-toggle');
        const toggleText = card.querySelector('.toggle-text');

        if (property.status === 'available') {
          toggleText.textContent = 'Mark as Rented';
          statusToggle.classList.add('text-orange-600');
        } else {
          toggleText.textContent = 'Mark as Available';
          statusToggle.classList.add('text-green-600');
        }

        statusToggle.addEventListener('click', function () {
          togglePropertyStatus(property.id);
        });

        container.appendChild(card);
      });

      // Hide loading indicator
      loadingIndicator.classList.add('hidden');

      // Re-initialize Lucide icons for dynamically added content
      lucide.createIcons();

    } catch (error) {
      console.error('Error loading properties:', error);
      loadingIndicator.classList.add('hidden');
      errorMsg.textContent = `Error: ${error.message}`;
      errorMsg.classList.remove('hidden');
    }
  }

  // Simple CSV line parser
  function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      if (char === '"') inQuotes = !inQuotes;
      else if (char === ',' && !inQuotes) {
        result.push(current);
        current = '';
      } else {
        current += char;
      }
    }
    result.push(current);
    return result;
  }

  // Toggle property status
  function togglePropertyStatus(propertyId) {
    try {
      const properties = JSON.parse(localStorage.getItem('properties') || '[]');
      const propertyIndex = properties.findIndex(p => p.id == propertyId);
      if (propertyIndex !== -1) {
        properties[propertyIndex].status = properties[propertyIndex].status === 'available' ? 'rented' : 'available';
        localStorage.setItem('properties', JSON.stringify(properties));
        loadUserProperties(); // Refresh UI
      }
    } catch (error) {
      console.error('Error toggling status:', error);
    }
  }

  // Load properties on page load
  document.addEventListener('DOMContentLoaded', loadUserProperties);
</script>
</body>
</html>